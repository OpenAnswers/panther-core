<!DOCTYPE html>

<html>
<head>
  <title>event_rules.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="action.html">
                  action.coffee
                </a>
              
                
                <a class="source" href="agent.html">
                  agent.coffee
                </a>
              
                
                <a class="source" href="agent_generic.html">
                  agent_generic.coffee
                </a>
              
                
                <a class="source" href="agent_graylog.html">
                  agent_graylog.coffee
                </a>
              
                
                <a class="source" href="agent_http.html">
                  agent_http.coffee
                </a>
              
                
                <a class="source" href="agent_syslogd.html">
                  agent_syslogd.coffee
                </a>
              
                
                <a class="source" href="agents.html">
                  agents.coffee
                </a>
              
                
                <a class="source" href="agentsyslog.html">
                  agentsyslog.coffee
                </a>
              
                
                <a class="source" href="day_time.html">
                  day_time.coffee
                </a>
              
                
                <a class="source" href="dedupe.html">
                  dedupe.coffee
                </a>
              
                
                <a class="source" href="discard.html">
                  discard.coffee
                </a>
              
                
                <a class="source" href="event.html">
                  event.coffee
                </a>
              
                
                <a class="source" href="event_rules.html">
                  event_rules.coffee
                </a>
              
                
                <a class="source" href="group.html">
                  group.coffee
                </a>
              
                
                <a class="source" href="groups.html">
                  groups.coffee
                </a>
              
                
                <a class="source" href="index.html">
                  index.coffee
                </a>
              
                
                <a class="source" href="levels.html">
                  levels.coffee
                </a>
              
                
                <a class="source" href="option.html">
                  option.coffee
                </a>
              
                
                <a class="source" href="rule.html">
                  rule.coffee
                </a>
              
                
                <a class="source" href="rule_set.html">
                  rule_set.coffee
                </a>
              
                
                <a class="source" href="schedule.html">
                  schedule.coffee
                </a>
              
                
                <a class="source" href="schedules.html">
                  schedules.coffee
                </a>
              
                
                <a class="source" href="select.html">
                  select.coffee
                </a>
              
                
                <a class="source" href="select_all.html">
                  select_all.coffee
                </a>
              
                
                <a class="source" href="select_base.html">
                  select_base.coffee
                </a>
              
                
                <a class="source" href="select_ends_with.html">
                  select_ends_with.coffee
                </a>
              
                
                <a class="source" href="select_equals.html">
                  select_equals.coffee
                </a>
              
                
                <a class="source" href="select_field_exists.html">
                  select_field_exists.coffee
                </a>
              
                
                <a class="source" href="select_field_missing.html">
                  select_field_missing.coffee
                </a>
              
                
                <a class="source" href="select_greater_than.html">
                  select_greater_than.coffee
                </a>
              
                
                <a class="source" href="select_less_than.html">
                  select_less_than.coffee
                </a>
              
                
                <a class="source" href="select_match.html">
                  select_match.coffee
                </a>
              
                
                <a class="source" href="select_none.html">
                  select_none.coffee
                </a>
              
                
                <a class="source" href="select_schedule.html">
                  select_schedule.coffee
                </a>
              
                
                <a class="source" href="select_starts_with.html">
                  select_starts_with.coffee
                </a>
              
                
                <a class="source" href="transforms.html">
                  transforms.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>event_rules.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>logging modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>{logger, debug} = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;oa-logging&#x27;</span>)(<span class="hljs-string">&#x27;oa:event:rules:event_rules&#x27;</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>npm modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;bluebird&#x27;</span>
yaml    = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;js-yaml&#x27;</span>
tmp     = <span class="hljs-built_in">Promise</span>.promisifyAll <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;tmp&#x27;</span>)
moment  = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;moment&#x27;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>node modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>fs      = <span class="hljs-built_in">Promise</span>.promisifyAll <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)
mvAsync = <span class="hljs-built_in">Promise</span>.promisify <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mv&#x27;</span>)
path    = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;path&#x27;</span>
git     = <span class="hljs-built_in">Promise</span>.promisifyAll <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;gift&#x27;</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>oa modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Errors          = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;oa-errors&#x27;</span>
{throw_error, _, delay, objhash} = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;oa-helpers&#x27;</span>

{RuleSet} = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./rule_set&#x27;</span>
{Groups}  = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./groups&#x27;</span>
{Event}   = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./event&#x27;</span>

{Action}  = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./action&#x27;</span>
{Select}  = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./select&#x27;</span>
{Option}  = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./option&#x27;</span>

{Agents}  = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./agents&#x27;</span>
{Schedules} = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./schedules&#x27;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="eventrules">EventRules</h2>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>EventRules is the grouping of all the rules for the event system
It houses the syslog rules, global rules, group rules and metadata
for the rules system</p>
<p><code>@globals</code> has the global RuleSet
<code>@groups</code> contains the RuleSet for each group, by key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> @<span class="hljs-title">EventRules</span></span>

  @load: <span class="hljs-function"><span class="hljs-params">(path)</span> -&gt;</span>

    debug <span class="hljs-string">&#x27;Reading yaml file&#x27;</span>, path
    data = fs.readFileSync path</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>this is an <em>unsafe</em> load for regex objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    doc  = yaml.load data</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>catch e
logger.error ‘Error loading yaml’, e</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>convenience static to commit and push a file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  @git_commit_and_push: <span class="hljs-function"><span class="hljs-params">(yaml_path, msg, opts = {})</span>-&gt;</span>
    <span class="hljs-keyword">unless</span> opts.git_push
      logger.warn <span class="hljs-string">&quot;Attempting to commit,push but GIT is disabled at <span class="hljs-subst">#{yaml_path}</span>&quot;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve <span class="hljs-literal">true</span>

    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> ( resolve,reject)-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>setup paths</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      path_repo = path.dirname yaml_path
      yaml_filename = path.basename yaml_path</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>setup repo as promised</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      repo = <span class="hljs-built_in">Promise</span>.promisifyAll git(path_repo)
      repo.commitAsync msg,
        all: <span class="hljs-literal">true</span>
        author: <span class="hljs-string">&quot;<span class="hljs-subst">#{opts.user_name}</span> &lt;<span class="hljs-subst">#{opts.user_email}</span>&gt;&quot;</span>
      .<span class="hljs-keyword">then</span> (res)-&gt;
        logger.info <span class="hljs-string">&quot;Committed&quot;</span>, res
        repo.remote_pushAsync <span class="hljs-string">&#x27;origin&#x27;</span>, <span class="hljs-string">&#x27;master&#x27;</span>
      .<span class="hljs-keyword">then</span> ( res )-&gt;
        resolve res
      .<span class="hljs-keyword">catch</span> (err)-&gt;
        logger.error <span class="hljs-string">&quot;Commit failed&quot;</span>, err
        reject err


  
  constructor: <span class="hljs-function"><span class="hljs-params">( opts = {} )</span> -&gt;</span>
    debug <span class="hljs-string">&#x27;creating new EventRules with:&#x27;</span>, opts</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>@cb   = opts.cb || -&gt;</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Option, reload_rules automatically</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @reload_rules = opts.reload_rules || <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>rules are being saved
FIXME: 0 - working</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @saving_counter = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>git commit msgs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @edit_msgs = []</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Callback to run on rules reload</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @reload_cb = opts.reload_cb || <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>yaml doc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @doc = opts.doc</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>path to yaml</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @path = opts.path <span class="hljs-comment">#|| @constructor.default_path()</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Queue of watch events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @watch_events = []

    <span class="hljs-keyword">if</span> opts.server
      @type = <span class="hljs-string">&#x27;server&#x27;</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> opts.agent
      @type = <span class="hljs-string">&#x27;agent&#x27;</span>
    <span class="hljs-keyword">else</span>
      @type = <span class="hljs-string">&#x27;none&#x27;</span>
    
    <span class="hljs-keyword">if</span> @doc
      @build_from_yaml()
    <span class="hljs-keyword">else</span>
      @load_yaml()

    @watch_rules() <span class="hljs-keyword">if</span> @path


  build_from_yaml: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    debug <span class="hljs-string">&#x27;Generating rules object for:&#x27;</span>, @doc, @type
    <span class="hljs-keyword">switch</span> @type
      <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;server&#x27;</span>
        logger.info <span class="hljs-string">&#x27;Generating server rules from doc&#x27;</span>
        @generate_rules_server @doc
      <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;agent&#x27;</span>
        logger.info <span class="hljs-string">&#x27;Generating agent rules from doc&#x27;</span>
        @generate_rules_agent @doc
      <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;none&#x27;</span>
        logger.info <span class="hljs-string">&#x27;Generating rules from doc&#x27;</span>
        @generate_rules @doc
    
    @edited = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h6 id="watch_rules">watch_rules()</h6>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Uses a queue and delay of 1 second so things like truncating the
file before writing it out don’t get picked up
Not perfect if there are lots of seperate events triggered on the
file but good enough for the moment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  watch_rules: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    @stop_rules_watch()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> @reload_rules
    self = @
    watch_dir = path.dirname @path
    watch_file = path.basename @path
    logger.info <span class="hljs-string">&#x27;Setting up file watch on [%s] for [%s]&#x27;</span>, watch_dir, watch_file
    @watch = fs.watch watch_dir, <span class="hljs-function"><span class="hljs-params">( event, path )</span>-&gt;</span>
      debug <span class="hljs-string">&#x27;change detected ev[%s] path[%s]&#x27;</span>, event, path
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> path <span class="hljs-keyword">is</span> watch_file
      logger.info <span class="hljs-string">&quot;Rules file changed, waiting 1 seconds for node fs.watch&quot;</span>, path, event
      
      self.watch_events.push {event: event, path: path}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Delay a bit so multiple quick events are batched
into a single reload</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      delay <span class="hljs-number">1000</span>, <span class="hljs-function">-&gt;</span>
        debug <span class="hljs-string">&#x27;timer for watch change is running&#x27;</span>, self.watch_events.length
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> self.watch_events.length &gt; <span class="hljs-number">0</span>
        self.reload( event, path )
        self.watch_events = []

  stop_rules_watch: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-keyword">if</span> @watch <span class="hljs-keyword">and</span> @watch.close
      @watch.close()
    <span class="hljs-keyword">else</span>
      <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h6 id="load_yaml-path-">@load_yaml( path )</h6>
<p>Load a yaml file into the rules object model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  load_yaml: <span class="hljs-function"><span class="hljs-params">( yaml_path = @path )</span>-&gt;</span>
    @doc  = @constructor.load yaml_path
    @build_from_yaml()</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h6 id="reload">@reload()</h6>
<p>Reload the file on disk.
Used for discarding in memory changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reload: <span class="hljs-function"><span class="hljs-params">( ev = <span class="hljs-string">&#x27;reload&#x27;</span>, evpath = @path )</span>-&gt;</span>
    @load_yaml()
    @reload_cb ev, evpath <span class="hljs-keyword">if</span> @reload_cb</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h6 id="have_edits">have_edits()</h6>
<p>Flag to check if a rule set has modification that
have not been saved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  have_edits: <span class="hljs-function">-&gt;</span>
    @edited</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h6 id="set_edited_flag">set_edited_flag()</h6>
<p>Set the edited flag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set_edited_flag: <span class="hljs-function">-&gt;</span>
    @edited = <span class="hljs-literal">true</span>

  append_edited_msg: <span class="hljs-function"><span class="hljs-params">(msg)</span>-&gt;</span>
    @edit_msgs.push msg
    logger.debug <span class="hljs-string">&quot;APPENDING msg &quot;</span>, msg

  have_edited_msgs: <span class="hljs-function">-&gt;</span>
    @edit_msgs.length &gt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h6 id="to_yaml_obj-options-">@to_yaml_obj( options )</h6>
<p>Dump the rules back to yaml format</p>
<p>Options:</p>
<ul>
<li><code>hash</code> <code>true/false</code> a sha1 hash of the complete yaml object
 will be attached.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  to_yaml_obj: <span class="hljs-function"><span class="hljs-params">( options = {} )</span>-&gt;</span>
    o = {}
    <span class="hljs-keyword">if</span> @agent
      o.agent = @agent.to_yaml_obj()
    <span class="hljs-keyword">if</span> @globals
      o.globals =
        rules: @globals.to_yaml_obj()  <span class="hljs-comment"># Why does this need `rules:`?</span>
    <span class="hljs-keyword">if</span> @groups
      o.groups = @groups.to_yaml_obj()

    <span class="hljs-keyword">if</span> @schedules
      o.schedules = @schedules.to_yaml_obj()
    <span class="hljs-keyword">if</span> options.hash
      hash = objhash o
      o.hash = hash
    
    o.metadata = {}
    o.metadata.save_date = <span class="hljs-built_in">Date</span>.now()
    o</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h6 id="to_yaml">@to_yaml()</h6>
<p>Convert to yaml text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  to_yaml: <span class="hljs-function"><span class="hljs-params">( options )</span>-&gt;</span>
    yaml.dump @to_yaml_obj(options)</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h6 id="save_yaml_async">@save_yaml_async()</h6>
<p>Save event rules back to the yaml file, first creating a
temp file, moving the current file to a backup, then moving
the temp file into place.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  save_yaml_async: <span class="hljs-function"><span class="hljs-params">( yaml_path = @path )</span>-&gt;</span>
    self = @
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> ( resolve, reject )-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>mv file to file.date
save new file</p>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>return true</p>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>increment lock and test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.saving_counter +=<span class="hljs-number">1</span>
      debug <span class="hljs-string">&#x27;saving_counter = &#x27;</span>, self.saving_counter
      <span class="hljs-keyword">unless</span> self.saving_counter == <span class="hljs-number">1</span>
        logger.error <span class="hljs-string">&#x27;ASSERT saving counter&#x27;</span>, self.saving_counter
        <span class="hljs-keyword">return</span> reject( <span class="hljs-string">&quot;rules are being saved by someone else&quot;</span> )

      doc = self.to_yaml()

      debug <span class="hljs-string">&#x27;save_yaml generated a yaml doc&#x27;</span>, <span class="hljs-string">&quot;\n&quot;</span> + doc

      tmp_path = <span class="hljs-string">&#x27;&#x27;</span>
      tmp_cleanup_cb = <span class="hljs-literal">null</span>
<span class="hljs-function">
      <span class="hljs-title">moveFileAsync</span> = <span class="hljs-params">( path, back )</span>-&gt;</span>
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> ( resolve, reject )-&gt;
          mvAsync path, back
          .<span class="hljs-keyword">then</span> ( res )-&gt;
            resolve res
          .<span class="hljs-keyword">catch</span> ( error )-&gt;
            <span class="hljs-keyword">if</span> error.code <span class="hljs-keyword">is</span> <span class="hljs-string">&#x27;ENOENT&#x27;</span>
              <span class="hljs-keyword">return</span> resolve <span class="hljs-string">&#x27;no existing file to copy&#x27;</span>
            reject error</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>First create a temp file to write to</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      tmp.fileAsync()
      .<span class="hljs-keyword">then</span> ( path, fd, cleanup_cb )-&gt;
        debug <span class="hljs-string">&#x27;Tmp file save path fd cb&#x27;</span>, path, fd, cleanup_cb</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>.spread allows an array of arguments to be passed into this function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        tmp_path = path
        tmp_cleanup_cb = cleanup_cb</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Now write the tmp yaml file, create a backup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        logger.info <span class="hljs-string">&#x27;Writing yaml document to [%s]&#x27;</span>, tmp_path
        fs.writeFileAsync tmp_path, doc

      .<span class="hljs-keyword">then</span> ( res )-&gt;
        debug <span class="hljs-string">&#x27;save_yaml: after tmp write&#x27;</span>, res
        fs.statAsync yaml_path
      .<span class="hljs-keyword">then</span> ( stat )-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Backup the current file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        datestamp = moment().format(<span class="hljs-string">&quot;YYYYMMDD-hhmmss&quot;</span>)
        backup_file = <span class="hljs-string">&quot;<span class="hljs-subst">#{yaml_path}</span>.<span class="hljs-subst">#{datestamp}</span>&quot;</span>

        logger.info <span class="hljs-string">&#x27;Creating backup yaml document [%s]&#x27;</span>, backup_file
        
        moveFileAsync yaml_path, backup_file

      .<span class="hljs-keyword">then</span> ( res )-&gt;
        debug <span class="hljs-string">&#x27;save_yaml: yaml renamed to backup&#x27;</span>, res</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Put the new file into place</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        logger.info <span class="hljs-string">&#x27;Moving yaml document to [%s]&#x27;</span>, tmp_path
        mvAsync tmp_path, yaml_path

      .<span class="hljs-keyword">then</span> ( res )-&gt;
        debug <span class="hljs-string">&#x27;save_yaml: temp yaml renamed to real&#x27;</span>, res
        logger.info <span class="hljs-string">&quot;YAML rules file written [<span class="hljs-subst">#{yaml_path}</span>]&quot;</span>
        self.edited = <span class="hljs-literal">false</span>
        resolve()

      .<span class="hljs-keyword">catch</span> ( error )-&gt;
        logger.error <span class="hljs-string">&quot;Error saving yaml file [%s]&quot;</span>, error, error.stack
        debug <span class="hljs-string">&#x27;save_yaml running temp cleanup after error&#x27;</span>
        reject( error )
      
    .<span class="hljs-keyword">finally</span> -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>decrement the lock</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.saving_counter -=<span class="hljs-number">1</span>
      debug <span class="hljs-string">&#x27;finally save_yaml_async&#x27;</span>, self.saving_counter</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Reload from file
@constructor.load @path</p>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h6 id="save_yaml_git_async">save_yaml_git_async()</h6>
<p>Save event rules back to the yaml file and commit to git
instead of saving a backup file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  save_yaml_git_async: <span class="hljs-function"><span class="hljs-params">( yaml_path = @path, opts = {} )</span>-&gt;</span>
    self = @
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> ( resolve, reject )-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>increment lock and test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.saving_counter +=<span class="hljs-number">1</span>
      debug <span class="hljs-string">&#x27;saving_counter = &#x27;</span>, self.saving_counter
      <span class="hljs-keyword">unless</span> self.saving_counter == <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> reject( <span class="hljs-string">&quot;rules are being saved by someone else&quot;</span> )</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Gen our rules yaml</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      doc = self.to_yaml()
      debug <span class="hljs-string">&#x27;save_yaml_git generated a yaml doc&#x27;</span>, <span class="hljs-string">&quot;\n&quot;</span> + doc</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Setup git paths</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      path_repo = path.dirname(yaml_path)
      yaml_filename = path.basename(yaml_path)
      logger.info <span class="hljs-string">&#x27;Writing yaml document to git [%s] [%s]&#x27;</span>, yaml_path, path_repo</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Place to store the repo ref</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      repo = <span class="hljs-built_in">Promise</span>.promisifyAll git(path_repo)
      repo_index = <span class="hljs-literal">null</span>
      
      fs.writeFileAsync yaml_path, doc
      .<span class="hljs-keyword">then</span> ( res )-&gt;
        debug <span class="hljs-string">&#x27;save_yaml_git: yaml written to file&#x27;</span>, yaml_path
        logger.info <span class="hljs-string">&quot;YAML rules file written [<span class="hljs-subst">#{yaml_path}</span>]&quot;</span>
        self.edited = <span class="hljs-literal">false</span>
        repo.addAsync yaml_filename
      .<span class="hljs-keyword">then</span> ( res )-&gt;
        debug <span class="hljs-string">&#x27;save_yaml_git: yaml_filename added to git [%s] [%s]&#x27;</span>, res, yaml_filename

        commit_msg = <span class="hljs-string">&quot;Rules UI deploy - <span class="hljs-subst">#{opts.user_name}</span>&quot;</span>
        <span class="hljs-keyword">if</span> self.have_edited_msgs()
          commit_msg += <span class="hljs-string">&quot;\n&quot;</span> + self.edit_msgs.join <span class="hljs-string">&#x27;\n&#x27;</span>
          self.edit_msgs = []

        self.git_commit_Async repo, commit_msg,
          all: <span class="hljs-literal">true</span>
          author: <span class="hljs-string">&quot;<span class="hljs-subst">#{opts.user_name}</span> &lt;<span class="hljs-subst">#{opts.user_email}</span>&gt;&quot;</span>
      .<span class="hljs-keyword">then</span> ( res )-&gt;
        debug <span class="hljs-string">&#x27;save_yaml_git: git commit res&#x27;</span>, res
        ret = <span class="hljs-keyword">if</span> opts.git_push
          repo.remote_pushAsync <span class="hljs-string">&#x27;origin&#x27;</span>, <span class="hljs-string">&#x27;master&#x27;</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-literal">false</span>
      .<span class="hljs-keyword">then</span> ( res )-&gt;
        debug <span class="hljs-string">&#x27;save_yaml_git: push res or false&#x27;</span>, res
        resolve(res)

      .<span class="hljs-keyword">catch</span> ( error, out, err )-&gt;
        logger.error <span class="hljs-string">&quot;Error saving yaml file to git[%s]&quot;</span>, error, error.stack
        logger.error <span class="hljs-string">&quot;stdout&quot;</span>, error.stdout
        logger.error <span class="hljs-string">&quot;stderr&quot;</span>, error.stderr
        debug <span class="hljs-string">&#x27;error&#x27;</span>, out, err
        reject( error )
    .<span class="hljs-keyword">finally</span> -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>decrement the lock</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      debug <span class="hljs-string">&#x27;decrementing counter&#x27;</span>, self.saving_counter
      self.saving_counter -=<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p><code>git_commit_Async</code>
Create a function so we can capture stdout and stderr on
the error message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  git_commit_Async: <span class="hljs-function"><span class="hljs-params">( repo, msg, opts = {} )</span>-&gt;</span>
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (resolve,reject)-&gt;
      repo.commit msg, opts, <span class="hljs-function"><span class="hljs-params">( error, stdout, stderr )</span>-&gt;</span>
        <span class="hljs-keyword">if</span> error
          error.stdout = stdout
          error.stederr = stderr
          reject error
        resolve stdout

  groups_array: <span class="hljs-function">-&gt;</span>
    @groups.store_order

  has_group: <span class="hljs-function"><span class="hljs-params">( group )</span>-&gt;</span>
    @groups.has_group group</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>This was an attempt to expose a single interface via EventRules
to all the underlying modules. This means the public API to
would all be via EventRules,  but this might grow way too big</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  action_names: <span class="hljs-function">-&gt;</span>
    _.keys Action.types

  select_names: <span class="hljs-function">-&gt;</span>
    _.keys Select.types

  option_names: <span class="hljs-function">-&gt;</span>
    _.keys Option.types

  find: <span class="hljs-function"><span class="hljs-params">( ids )</span>-&gt;</span>
    self = @
    r = []

    _.forEach ids, <span class="hljs-function"><span class="hljs-params">(id)</span>-&gt;</span>
      <span class="hljs-keyword">if</span> self.groups 
        r = _.flatten self.groups.find id
    r</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Generate all the data from the yaml definitions
Agent
Globals
Groups
Schedules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  generate_rules: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>global_discard
global_dedupe</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @schedules = Schedules.generate @doc.schedules, @</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Agent specifics</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @agent = Agents.generate @doc.agent, @</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Globals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">unless</span> @doc.globals?
      throw_error <span class="hljs-string">&#x27;definition missing globals&#x27;</span>
    
    @globals = RuleSet.generate @doc.globals, @
    
    debug <span class="hljs-string">&#x27;generate rules setup globals&#x27;</span>, @globals</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Groups</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">unless</span> @doc.groups?
      throw_error <span class="hljs-string">&#x27;definition missing groups&#x27;</span>

    @groups = Groups.generate @doc.groups, @

    debug <span class="hljs-string">&#x27;generate rules has setup groups&#x27;</span>, @groups.store_order</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Return the document</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @doc</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Generate all the data from the yaml definitions
Server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  generate_rules_server: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Schedules
must be parsed first as they are refrenced after</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    @schedules = Schedules.generate @doc.schedules, @</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Globals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> @doc.agent
      @agent = Agents.generate @doc.agent

    <span class="hljs-keyword">unless</span> @doc.globals?
      throw_error <span class="hljs-string">&#x27;Rule yaml definition is missing `globals`&#x27;</span>
    
    @globals = RuleSet.generate @doc.globals, @</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>TODO </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    debug <span class="hljs-string">&#x27;generate rules setup globals&#x27;</span>, @globals</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Groups</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">unless</span> @doc.groups?
      throw_error <span class="hljs-string">&#x27;Rule yaml definition is missing `groups`&#x27;</span>

    @groups = Groups.generate @doc.groups, @
    
    debug <span class="hljs-string">&#x27;generate rules has setup groups&#x27;</span>, @groups.store_order


    @doc</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Generate all the data from the yaml definitions
Agent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  generate_rules_agent: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">unless</span> @doc.agent
      throw_error <span class="hljs-string">&#x27;Rule yaml definition is missing `agent`&#x27;</span>
    @agent = Agents.generate @doc.agent, @
    @doc</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>FIXME time to replace the @Identifier with a hash
current thinking is google’s Farmhash</p>

            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <h6 id="run-event-"><code>run( event )</code></h6>

            </div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>The main entry point for events.
A json event goes into the rules
A copy of the event, possibly modified
 comes out after rules processing
options{ tracking_matches: true|false }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run: <span class="hljs-function"><span class="hljs-params">(event_obj, options = {})</span> -&gt;</span>
    self = @
    <span class="hljs-keyword">unless</span> event_obj <span class="hljs-keyword">instanceof</span> Event</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Create a rule Event with some extras</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      event_obj = Event.generate event_obj

    <span class="hljs-keyword">if</span> options.tracking_matches
      event_obj.set_tracking options.tracking_matches

    debug <span class="hljs-string">&#x27;starting rules procesing for event&#x27;</span>, event_obj.original
    ts_start = <span class="hljs-built_in">Date</span>.now()</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Sync
apply global rules first</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> self.globals
      self.globals.run event_obj</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>close off any global match tracking</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      event_obj.close_matched_global()</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>apply group rules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> self.groups
      self.groups.run event_obj</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>finally set identifier</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> self.globals <span class="hljs-keyword">or</span> self.groups
      gl = <span class="hljs-keyword">if</span> self.globals <span class="hljs-keyword">then</span> <span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;false&quot;</span>
      gr = <span class="hljs-keyword">if</span> self.groups <span class="hljs-keyword">then</span> <span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;false&quot;</span>
      debug <span class="hljs-string">&#x27;setting identifier GL=%s, GR=%s&#x27;</span>, gl, gr
      event_obj.populate_identifier()
    <span class="hljs-keyword">else</span>
      event_obj.populate_pre_identifier()

    ts_total = <span class="hljs-built_in">Date</span>.now() - ts_start
    debug <span class="hljs-string">&#x27;rule processing took %s ms&#x27;</span>, ts_total</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h1 id="promised">Promised</h1>
<p>self.globals.run event_obj
.then (event_obj) -&gt;
  self.groups.run event_obj
#.then (event_obj) -&gt;
  #self.globals_post.run event_obj
.catch (err) -&gt;
  console.error ‘Error’, err, err.stack
  throw_error err</p>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>event_obj</p>

            </div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>A <code>EventRule.{id}</code> event will be fired when the rule
processing is complete. It will contain the event_obj</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-keyword">return</span> event_obj</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <h6 id="agent_map-input_message-"><code>agent_map( input_message )</code></h6>

            </div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Sends a raw input message through the agent mappings so
we have all the fields right for the rules to start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  agent_map: <span class="hljs-function"><span class="hljs-params">( input_message, event_obj = {} )</span> -&gt;</span>
    self = @</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Create a rule Event with some extras</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">unless</span> event_obj <span class="hljs-keyword">instanceof</span> Event
      event_obj = Event.generate event_obj

    event_obj.set_input_object input_message

    @agent.run event_obj

    <span class="hljs-keyword">return</span> event_obj</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <h6 id="rules-new_object-input_message_object-"><code>rules( new_object, input_message_object )</code></h6>

            </div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>This is the event console <em>monitors</em> entry point.
Keeping it with the same signature for the moment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rules: <span class="hljs-function"><span class="hljs-params">( new_object, input_message )</span>-&gt;</span>
    event_obj = @agent_map input_message, new_object
    processed = @run event_obj</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>monitors expect the incoming object to be modified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.assign new_object, processed.copy</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Dump the simple js object back out to the rules processing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    new_object</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
