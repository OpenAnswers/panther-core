<!DOCTYPE html>

<html>
<head>
  <title>agent.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="action.html">
                  action.coffee
                </a>
              
                
                <a class="source" href="agent.html">
                  agent.coffee
                </a>
              
                
                <a class="source" href="agent_generic.html">
                  agent_generic.coffee
                </a>
              
                
                <a class="source" href="agent_graylog.html">
                  agent_graylog.coffee
                </a>
              
                
                <a class="source" href="agent_http.html">
                  agent_http.coffee
                </a>
              
                
                <a class="source" href="agent_syslogd.html">
                  agent_syslogd.coffee
                </a>
              
                
                <a class="source" href="agents.html">
                  agents.coffee
                </a>
              
                
                <a class="source" href="agentsyslog.html">
                  agentsyslog.coffee
                </a>
              
                
                <a class="source" href="day_time.html">
                  day_time.coffee
                </a>
              
                
                <a class="source" href="dedupe.html">
                  dedupe.coffee
                </a>
              
                
                <a class="source" href="discard.html">
                  discard.coffee
                </a>
              
                
                <a class="source" href="event.html">
                  event.coffee
                </a>
              
                
                <a class="source" href="event_rules.html">
                  event_rules.coffee
                </a>
              
                
                <a class="source" href="group.html">
                  group.coffee
                </a>
              
                
                <a class="source" href="groups.html">
                  groups.coffee
                </a>
              
                
                <a class="source" href="index.html">
                  index.coffee
                </a>
              
                
                <a class="source" href="levels.html">
                  levels.coffee
                </a>
              
                
                <a class="source" href="option.html">
                  option.coffee
                </a>
              
                
                <a class="source" href="rule.html">
                  rule.coffee
                </a>
              
                
                <a class="source" href="rule_set.html">
                  rule_set.coffee
                </a>
              
                
                <a class="source" href="schedule.html">
                  schedule.coffee
                </a>
              
                
                <a class="source" href="schedules.html">
                  schedules.coffee
                </a>
              
                
                <a class="source" href="select.html">
                  select.coffee
                </a>
              
                
                <a class="source" href="select_all.html">
                  select_all.coffee
                </a>
              
                
                <a class="source" href="select_base.html">
                  select_base.coffee
                </a>
              
                
                <a class="source" href="select_ends_with.html">
                  select_ends_with.coffee
                </a>
              
                
                <a class="source" href="select_equals.html">
                  select_equals.coffee
                </a>
              
                
                <a class="source" href="select_field_exists.html">
                  select_field_exists.coffee
                </a>
              
                
                <a class="source" href="select_field_missing.html">
                  select_field_missing.coffee
                </a>
              
                
                <a class="source" href="select_greater_than.html">
                  select_greater_than.coffee
                </a>
              
                
                <a class="source" href="select_less_than.html">
                  select_less_than.coffee
                </a>
              
                
                <a class="source" href="select_match.html">
                  select_match.coffee
                </a>
              
                
                <a class="source" href="select_none.html">
                  select_none.coffee
                </a>
              
                
                <a class="source" href="select_schedule.html">
                  select_schedule.coffee
                </a>
              
                
                <a class="source" href="select_starts_with.html">
                  select_starts_with.coffee
                </a>
              
                
                <a class="source" href="transforms.html">
                  transforms.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>agent.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="agent">Agent</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>(c) OpenAnswers Ltd 2015
<a href="mailto:&#109;&#x61;&#116;&#x74;&#64;&#111;&#x70;&#101;&#110;&#97;&#x6e;&#x73;&#119;&#101;&#x72;&#x73;&#46;&#x63;&#111;&#x2e;&#x75;&#107;">&#109;&#x61;&#116;&#x74;&#64;&#111;&#x70;&#101;&#110;&#97;&#x6e;&#x73;&#119;&#101;&#x72;&#x73;&#46;&#x63;&#111;&#x2e;&#x75;&#107;</a></p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>logging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>{logger, debug} = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;oa-logging&#x27;</span>)(<span class="hljs-string">&#x27;oa:event:rules:agent&#x27;</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>nodejs modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>fs = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;fs&#x27;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>npm modules
Promise           = require ‘bluebird’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>yaml = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;js-yaml&#x27;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>oa modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Errors        = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;oa-errors&#x27;</span>
{ RuleSet }   = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./rule_set&#x27;</span>
{ _ }         = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;oa-helpers&#x27;</span>
{ Transforms } = <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;./transforms&#x27;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3 id="class-agent">class Agent</h3>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Agents can have specific rules, this is the base for
the Agent Specifics to inherit from</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Agent</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>A default identifier for agents that don’t override</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  @identifier: <span class="hljs-string">&#x27;{node}:{severity}:{summary}&#x27;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>These are the possible transforms to run on fields
Should be configured via <code>field_transform</code> in yaml</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>   field_transforme:
     {{field_name}}: {{transform_name}}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  @generate: <span class="hljs-function"><span class="hljs-params">( yaml_def, agent )</span> -&gt;</span>
    agent = <span class="hljs-keyword">new</span> Agent <span class="hljs-keyword">unless</span> agent
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.ValidationError <span class="hljs-string">&#x27;No definition&#x27;</span> <span class="hljs-keyword">unless</span> yaml_def?

    <span class="hljs-keyword">if</span> yaml_def.field_map
      agent.field_map yaml_def.field_map

    <span class="hljs-keyword">if</span> yaml_def.identifier
      agent.identifier yaml_def.identifier
    <span class="hljs-keyword">else</span>
      agent.identifier @identifier

    <span class="hljs-keyword">if</span> yaml_def.field_transform
      agent.field_transform yaml_def.field_transform

    <span class="hljs-keyword">if</span> yaml_def.rules
      agent.rule_set RuleSet.generate( yaml_def )
    <span class="hljs-keyword">else</span>
      agent.rule_set <span class="hljs-keyword">new</span> RuleSet

    agent


  constructor: <span class="hljs-function"><span class="hljs-params">( options = {} )</span>-&gt;</span>
    @_field_map = <span class="hljs-literal">null</span>
    @_identifier = @constructor.identifier
    @_field_transform = <span class="hljs-literal">null</span>

    @_rule_set = <span class="hljs-keyword">new</span> RuleSet

    <span class="hljs-keyword">if</span> options.path
      @path = options.path
      @load()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="instance-properties">Instance properties</h2>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Store the type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  type: <span class="hljs-function"><span class="hljs-params">( _type )</span>-&gt;</span>
    <span class="hljs-keyword">if</span> _type
      <span class="hljs-keyword">unless</span> _.isString( _type )
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.ValidationError <span class="hljs-string">&quot;YAML rules agent `type` must be a string [<span class="hljs-subst">#{_type}</span>]&quot;</span>
      @_type = _type
    @_type</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Store the identifier</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  identifier: <span class="hljs-function"><span class="hljs-params">( _identifier )</span>-&gt;</span>
    <span class="hljs-keyword">if</span> _identifier 
      <span class="hljs-keyword">unless</span> _.isString( _identifier )
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.ValidationError <span class="hljs-string">&quot;YAML rules agent `identifier` must be a string [<span class="hljs-subst">#{_identifier}</span>]&quot;</span>
      @_identifier = _identifier
    @_identifier</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Store the rule set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rule_set: <span class="hljs-function"><span class="hljs-params">( _rule_set )</span>-&gt;</span>
    <span class="hljs-keyword">if</span> _rule_set
      @_rule_set = _rule_set
    @_rule_set</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h6 id="field_map-has_map-">field_map( has_map )</h6>
<p>Store the field mappings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  field_map: <span class="hljs-function"><span class="hljs-params">( _field_map )</span>-&gt;</span>
    <span class="hljs-keyword">if</span> _field_map
      <span class="hljs-keyword">unless</span> _.isObject _field_map
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.ValidationError <span class="hljs-string">&quot;YAML rules agent `field_map` must be an object [<span class="hljs-subst">#{_field_map}</span>]&quot;</span>
      <span class="hljs-keyword">for</span> source, dest <span class="hljs-keyword">of</span> _field_map
        <span class="hljs-keyword">unless</span> _.isString(source)
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.ValidationError <span class="hljs-string">&quot;YAML rules agent `field_map` fields must be strings [<span class="hljs-subst">#{source}</span>]&quot;</span>
        <span class="hljs-keyword">unless</span> _.isString(dest)
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.ValidationError <span class="hljs-string">&quot;YAML rules agent `field_map` fields must be strings [<span class="hljs-subst">#{dest}</span>]&quot;</span>
      @_field_map = _field_map
    @_field_map</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h6 id="field_transform-transform-">field_transform( transform )</h6>
<p>Store the field transforms
Also checks if they are valid in the <code>available_transforms</code> array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  field_transform: <span class="hljs-function"><span class="hljs-params">( _field_transform )</span>-&gt;</span>
    <span class="hljs-keyword">if</span> _field_transform
      debug <span class="hljs-string">&#x27;Setting field_transform to&#x27;</span>, _field_transform, @constructor.available_transforms
      <span class="hljs-keyword">for</span> field, transforms <span class="hljs-keyword">of</span> _field_transform
        transforms = [transforms] <span class="hljs-keyword">unless</span> _.isArray transforms
        <span class="hljs-keyword">for</span> transform <span class="hljs-keyword">in</span> transforms
          <span class="hljs-keyword">unless</span> Transforms.available_transforms[transform]
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.ValidationError <span class="hljs-string">&quot;YAML rules agent section had an unknown field transform [<span class="hljs-subst">#{transform}</span>]&quot;</span>
        _field_transform[field] = transforms

      debug <span class="hljs-string">&#x27;Setting agent field_transforms to [%j]&#x27;</span>, _field_transform, <span class="hljs-string">&#x27;&#x27;</span>
      @_field_transform = _field_transform

    @_field_transform</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Load the agent info from a file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  load: <span class="hljs-function"><span class="hljs-params">( path = @path )</span>-&gt;</span>
    debug <span class="hljs-string">&#x27;Reading agent yaml file&#x27;</span>, @path
    
    @data = fs.readFileSync @path
    @doc = yaml.load @data

    <span class="hljs-keyword">if</span> @doc.agent?.field_map
      @field_map @doc.agent.field_map

    <span class="hljs-keyword">if</span> @doc.agent?.identifier
      @identifier @doc.agent.identifier

    <span class="hljs-keyword">if</span> @doc.agent?.field_transform
      @field_transform @doc.agent.field_transform</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h6 id="run-event_object-">run( event_object )</h6>
<p>Run the log event through all the agent generic mappings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run: <span class="hljs-function"><span class="hljs-params">( event_obj )</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Attach the default agent identifier
Formed: <code>{field}:{field}:{field}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> event_obj.get(<span class="hljs-string">&#x27;identifier&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
      event_obj.set <span class="hljs-string">&#x27;identifier&#x27;</span>, @_identifier</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Map incoming fields to new event fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @run_field_map( event_obj )</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Do any blanket transforms on the data, post mapping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @run_field_transform( event_obj )</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Send the event through any agent specific rules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @run_rules( event_obj )

    event_obj</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h6 id="run_field_transform-event_object-">run_field_transform( Event_object )</h6>
<p>Transform any fields on the way through
Modifies event_obj</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_field_transform: <span class="hljs-function"><span class="hljs-params">( event_obj )</span>-&gt;</span>
    debug <span class="hljs-string">&#x27;transforming&#x27;</span>, @_field_transform
    <span class="hljs-keyword">for</span> field, transforms <span class="hljs-keyword">of</span> @_field_transform
      <span class="hljs-keyword">for</span> transform <span class="hljs-keyword">in</span> transforms
        current = event_obj.get field
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> current?
        tranformed_val = Transforms.available_transforms[transform].function current
        debug <span class="hljs-string">&#x27;transforming field [%s] old[%s] new[%s]&#x27;</span>, field, current, tranformed_val
        event_obj.set field, tranformed_val
    <span class="hljs-literal">true</span> <span class="hljs-comment">#so the for loop doesn&#x27;t return an array</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h6 id="run_field_map-event_object-">run_field_map( event_object )</h6>
<p>Map an input field to a different event console field</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_field_map: <span class="hljs-function"><span class="hljs-params">( event_obj )</span>-&gt;</span>
    <span class="hljs-keyword">for</span> from_field, to_field <span class="hljs-keyword">of</span> @_field_map
      to_field_value = event_obj.get_input(from_field)
      debug <span class="hljs-string">&#x27;mapping&#x27;</span>, from_field, to_field, to_field_value
      event_obj.set to_field, to_field_value
    <span class="hljs-literal">true</span> <span class="hljs-comment">#so the for loop doesn&#x27;t return an array</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h6 id="run_rules-event_object-">run_rules( Event_object )</h6>
<p>Run an event though the agent rule set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run_rules: <span class="hljs-function"><span class="hljs-params">( event_obj )</span>-&gt;</span>
    debug <span class="hljs-string">&#x27;running agent rules&#x27;</span>
    @_rule_set.run event_obj</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Convert generic structure to yaml</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  to_yaml_obj: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    obj = {}
    obj.type = @_type
    obj.identifier = @_identifier
    obj.field_map = @_field_map
    obj.field_transform = @_field_transform
    obj.rules = <span class="hljs-keyword">if</span> @_rule_set <span class="hljs-keyword">then</span> @_rule_set.to_yaml_obj() <span class="hljs-keyword">else</span> []
    obj

  
  to_yaml: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    yaml.dump @to_yaml_obj()

<span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> =
  Agent: Agent</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
